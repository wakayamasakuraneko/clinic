<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>index9</title>
    <!-- FFçµæœã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµã‚Šè¾¼ã¿ã‚’è¿½åŠ ã€‚ -->
    <!-- ãƒ¯ã‚¯ãƒãƒ³ã€ãƒãƒŸå–ã‚Šã®æœŸé™åˆ‡ã‚Œæ©Ÿèƒ½ã‚’è¿½åŠ  -->
    <!-- https://chatgpt.com/c/69741008-6324-8322-8a29-d29390754100 -->
    <!-- å‰Šé™¤æ©Ÿèƒ½ã‚’è¿½åŠ  -->
    <link rel="stylesheet" href="ColorCss/status-color.css" />
    <link rel="stylesheet" href="ColorCss/label-color.css" />

    <style>
      body {
        font-family: sans-serif;
        margin: 10px;
        background-color: #f4f4f4;
        color: #333;
      }

      .container {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        max-width: 1200px;
        margin: auto;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        height: 40px;
      }

      h2 {
        font-size: 1.2rem;
        margin: 0;
      }

      .btn-main {
        padding: 6px 12px;
        cursor: pointer;
        background: #ff9800;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.9rem;
      }

      /* æ¤œç´¢ãƒ‘ãƒãƒ« */
      .controls-wrapper {
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f9f9f9;
        overflow: hidden;
      }

      .controls-summary {
        padding: 8px 15px;
        background: #eee;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
      }

      .controls-content {
        padding: 15px;
        display: none;
      }

      .controls-content.active {
        display: block;
      }

      .filter-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        font-size: 13px;
        margin-bottom: 10px;
      }

      .search-box {
        padding: 5px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 250px;
      }

      /* ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£ */
      .table-wrapper {
        max-height: 70vh;
        overflow-y: auto;
        border: 1px solid #ccc;
        background: white;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
      }

      thead th {
        position: sticky;
        top: 0;
        background-color: #eee;
        z-index: 20;
        border-bottom: 2px solid #ccc;
        padding: 8px;
        text-align: center;
        font-size: 12px;
      }

      .th-content-wrapper {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* 2åˆ—ç›®ï¼ˆçŠ¶æ…‹ï¼‰ã‚’ä¸­å¤®å¯„ã› */
      table td:nth-child(2) {
        text-align: center;
      }

      .sortable-label {
        cursor: pointer;
        color: #007bff;
        white-space: nowrap;
        flex-grow: 1;
      }

      .filter-trigger {
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 3px;
        background: #ddd;
        font-size: 10px;
        user-select: none;
      }

      /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (Fixedé…ç½®) */
      .filter-dropdown {
        display: none;
        position: fixed;
        z-index: 1000;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        min-width: 180px;
        padding: 12px;
        border-radius: 6px;
        font-weight: normal;
      }

      .filter-dropdown.active {
        display: block;
      }

      .dropdown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .close-btn {
        cursor: pointer;
        font-size: 18px;
        color: #999;
        line-height: 1;
      }

      .close-btn:hover {
        color: #333;
      }

      .dropdown-btns {
        display: flex;
        gap: 5px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
      }

      .btn-sm {
        padding: 3px 8px;
        cursor: pointer;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        font-size: 11px;
      }

      /* 2åˆ—ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º */
      .gender-grid,
      .ff-grid,
      .status-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 10px;
      }

      .gender-grid label,
      .ff-grid label,
      .status-grid label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        cursor: pointer;
      }

      /* è¡Œ */
      td {
        border: 1px solid #ccc;
        padding: 8px;
        font-size: 13px;
      }
      tr:hover {
        background-color: #fff9f0;
        cursor: pointer;
      }
      .thumb-cell {
        width: 50px;
        text-align: center;
      }
      .cat-thumb {
        width: 40px;
        height: 40px;
        border-radius: 20%;
        object-fit: cover;
      }

      /* ===== çŠ¶æ…‹ãƒãƒƒã‚¸ï¼ˆè‰²ã¯ status-color.css å´ã® st-* ãŒæ‹…å½“ï¼‰ ===== */
      .status-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: bold;
        border: 2px solid var(--st-color, #999);
        color: var(--st-color, #333);
        background: var(--st-bg, #eee);
      }

      /* æœŸé™è­¦å‘Šï¼šèµ¤å­— */
      .alert-text {
        color: #d32f2f;
        font-weight: bold;
      }

      /* æœŸé–“ï¼šã‚«ãƒ¼ãƒ‰ï¼†æ•°å€¤å…¥åŠ› */
      .filter-card {
        background: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .input-num {
        width: 35px;
        padding: 2px;
        text-align: center;
      }

      /* âš  ç‚¹æ»… */
      @keyframes blinkWarn {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0.25;
        }
      }
      .warn-icon {
        display: inline-block;
        margin-left: 4px;
        animation: blinkWarn 1s step-end infinite;
      }

      /* å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
      .ctx-menu {
        position: fixed;
        z-index: 2000;
        min-width: 180px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
        padding: 6px;
      }
      .ctx-item {
        width: 100%;
        text-align: left;
        border: 0;
        background: transparent;
        padding: 8px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
      }
      .ctx-item:hover {
        background: #f3f3f3;
      }
      .ctx-item.danger {
        color: #d32f2f;
        font-weight: bold;
      }
      .ctx-item.danger:hover {
        background: #ffebee;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header-row">
        <h2>çŒ«ãƒ»ä¿è­·å€‹ä½“ä¸€è¦§</h2>
        <div>
          <span id="counter" style="margin-right: 15px; font-weight: bold">ç™»éŒ²æ•°: 0åŒ¹ (è©²å½“: 0ä»¶)</span>
          <button class="btn-main" onclick="openDetail('new')">ï¼‹ æ–°è¦ç™»éŒ²</button>
        </div>
      </div>

      <div class="controls-wrapper">
        <div class="controls-summary" onclick="document.querySelector('.controls-content').classList.toggle('active')">
          <span>ğŸ” æ¤œç´¢ãƒ»çµã‚Šè¾¼ã¿æ¡ä»¶ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼‰</span>
        </div>
        <div class="controls-content">
          <div class="filter-group">
            <strong>æ¤œç´¢ï¼š</strong>
            <input
              type="text"
              id="searchKeyword"
              class="search-box"
              placeholder="åå‰ã€å‡ºèº«ç­‰ã§æ¤œç´¢..."
              oninput="updateView()"
            />
          </div>

          <div class="filter-group">
            <strong>æœŸé–“ï¼š</strong>

            <div class="filter-card">
              ãƒ¯ã‚¯ãƒãƒ³æœ€çµ‚ã‹ã‚‰
              <input type="number" id="alert_vac_y" class="input-num" value="0" oninput="updateView()" /> å¹´
              <input type="number" id="alert_vac_m" class="input-num" value="0" oninput="updateView()" /> ãƒ¶æœˆä»¥ä¸Š
            </div>

            <div class="filter-card">
              ãƒãƒŸå–ã‚Šæœ€æ–°ã‹ã‚‰
              <input type="number" id="alert_flea_m" class="input-num" value="0" oninput="updateView()" /> ãƒ¶æœˆä»¥ä¸Š
            </div>
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width: 50px">å†™çœŸ</th>

              <th>
                <div class="th-content-wrapper">
                  <span class="sortable-label" onclick="sortData('status')">çŠ¶æ…‹ â†•</span>
                  <span class="filter-trigger" onclick="toggleDropdown(event, 'statusDropdown')">â–¼</span>

                  <div id="statusDropdown" class="filter-dropdown" onclick="event.stopPropagation()">
                    <div class="dropdown-header">
                      <strong>çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</strong>
                      <span class="close-btn" onclick="closeDropdown('statusDropdown')">Ã—</span>
                    </div>

                    <div class="dropdown-btns">
                      <button class="btn-sm" onclick="toggleFilters('statusFilters', true)">å…¨é¸æŠ</button>
                      <button class="btn-sm" style="background: #666" onclick="toggleFilters('statusFilters', false)">
                        å…¨è§£é™¤
                      </button>
                    </div>

                    <div id="statusFilters" class="status-grid">
                      <label><input type="checkbox" value="ä¿è­·ä¸­" checked onchange="updateView()" /> ä¿è­·ä¸­</label>
                      <label><input type="checkbox" value="é ã‹ã‚Šä¸­" checked onchange="updateView()" /> é ã‹ã‚Šä¸­</label>
                      <label><input type="checkbox" value="æ²»ç™‚ä¸­" checked onchange="updateView()" /> æ²»ç™‚ä¸­</label>
                      <label><input type="checkbox" value="å…¥é™¢ä¸­" checked onchange="updateView()" /> å…¥é™¢ä¸­</label>
                      <label
                        ><input type="checkbox" value="Trialäºˆå®š" checked onchange="updateView()" /> Trialäºˆå®š</label
                      >
                      <label><input type="checkbox" value="Trialä¸­" checked onchange="updateView()" /> Trialä¸­</label>
                      <label><input type="checkbox" value="å’æ¥­" checked onchange="updateView()" /> å’æ¥­</label>
                      <label><input type="checkbox" value="å’æ¥­äºˆå®š" checked onchange="updateView()" /> å’æ¥­äºˆå®š</label>
                      <label><input type="checkbox" value="æ°¸çœ " checked onchange="updateView()" /> æ°¸çœ </label>
                      <label><input type="checkbox" value="æœªè¨­å®š" checked onchange="updateView()" /> æœªè¨­å®š</label>
                    </div>
                  </div>
                </div>
              </th>

              <th class="sortable" onclick="sortData('name')">åå‰ â†•</th>

              <th>
                <div class="th-content-wrapper">
                  <span class="sortable-label" onclick="sortData('gender')">æ€§åˆ¥ â†•</span>
                  <span class="filter-trigger" onclick="toggleDropdown(event, 'genderDropdown')">â–¼</span>

                  <div id="genderDropdown" class="filter-dropdown" onclick="event.stopPropagation()">
                    <div class="dropdown-header">
                      <strong>æ€§åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</strong>
                      <span class="close-btn" onclick="closeDropdown('genderDropdown')">Ã—</span>
                    </div>

                    <div class="dropdown-btns">
                      <button class="btn-sm" onclick="toggleFilters('genderFilters', true)">å…¨é¸æŠ</button>
                      <button class="btn-sm" style="background: #666" onclick="toggleFilters('genderFilters', false)">
                        å…¨è§£é™¤
                      </button>
                    </div>

                    <div id="genderFilters" class="gender-grid">
                      <label><input type="checkbox" value="ãƒ¡ã‚¹" checked onchange="updateView()" /> ãƒ¡ã‚¹</label>
                      <label><input type="checkbox" value="ã‚ªã‚¹" checked onchange="updateView()" /> ã‚ªã‚¹</label>
                      <label
                        ><input type="checkbox" value="ãƒ¡ã‚¹(é¿å¦Šæ¸ˆ)" checked onchange="updateView()" /> é¿å¦Šæ¸ˆ</label
                      >
                      <label
                        ><input type="checkbox" value="ã‚ªã‚¹(å»å‹¢æ¸ˆ)" checked onchange="updateView()" /> å»å‹¢æ¸ˆ</label
                      >
                      <label><input type="checkbox" value="ä¸æ˜" checked onchange="updateView()" /> ä¸æ˜</label>
                    </div>
                  </div>
                </div>
              </th>

              <th class="sortable" onclick="sortData('age_val')">å¹´é½¢ â†•</th>

              <th>
                <div class="th-content-wrapper">
                  <span class="sortable-label" onclick="sortData('ff_result')">FFçµæœ â†•</span>
                  <span class="filter-trigger" onclick="toggleDropdown(event, 'ffDropdown')">â–¼</span>

                  <div id="ffDropdown" class="filter-dropdown" onclick="event.stopPropagation()">
                    <div class="dropdown-header">
                      <strong>FFçµæœãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</strong>
                      <span class="close-btn" onclick="closeDropdown('ffDropdown')">Ã—</span>
                    </div>

                    <div class="dropdown-btns">
                      <button class="btn-sm" onclick="toggleFilters('ffFiltersHeader', true)">å…¨é¸æŠ</button>
                      <button class="btn-sm" style="background: #666" onclick="toggleFilters('ffFiltersHeader', false)">
                        å…¨è§£é™¤
                      </button>
                    </div>

                    <div id="ffFiltersHeader" class="ff-grid">
                      <label><input type="checkbox" value="æœªæ¤œæŸ»" checked onchange="updateView()" /> æœªæ¤œæŸ»</label>
                      <label><input type="checkbox" value="é™°æ€§" checked onchange="updateView()" /> é™°æ€§</label>
                      <label><input type="checkbox" value="FIV+" checked onchange="updateView()" /> FIV+</label>
                      <label><input type="checkbox" value="FeLV+" checked onchange="updateView()" /> FeLV+</label>
                      <label><input type="checkbox" value="ä¸¡æ–¹+" checked onchange="updateView()" /> ä¸¡æ–¹+</label>
                    </div>
                  </div>
                </div>
              </th>

              <th>å‡ºèº«åœ°</th>
              <th>å’æ¥­å…ˆ</th>
              <th class="sortable" onclick="sortData('last_vaccine')">æœ€çµ‚ãƒ¯ã‚¯ãƒãƒ³ â†•</th>
              <th class="sortable" onclick="sortData('last_flea')">æœ€æ–°ãƒãƒŸå–ã‚Š â†•</th>
            </tr>
          </thead>

          <tbody id="catList"></tbody>
        </table>
      </div>
    </div>
    <div id="ctxMenu" class="ctx-menu" hidden>
      <button type="button" id="ctxDeleteBtn" class="ctx-item danger">ã“ã®çŒ«ã‚’å‰Šé™¤</button>
      <button type="button" id="ctxCancelBtn" class="ctx-item">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    <script>
      /* --- DB & Data Logic --- */
      const DB_NAME = "CatManagementDB";
      const STORE_SUMMARY = "cat_summaries";
      const STORE_DETAIL = "cat_details";

      let cats = [];
      let sortConfig = { key: null, direction: 1 };

      async function loadData() {
        const db = await new Promise((res) => {
          const req = indexedDB.open(DB_NAME, 1);
          req.onsuccess = (e) => res(e.target.result);
        });

        cats = await new Promise((res) => {
          const tx = db.transaction(STORE_SUMMARY, "readonly");
          const req = tx.objectStore(STORE_SUMMARY).getAll();
          req.onsuccess = () => res(req.result);
        });

        updateView();
      }

      /* --- helpersï¼šindex8å†…ã«å¿…ãšç½®ãï¼ˆè­¦å‘ŠãŒå®‰å®šã™ã‚‹ï¼‰ --- */
      function formatDateShort(dateStr) {
        if (!dateStr) return "---";
        const d = new Date(dateStr);
        if (isNaN(d)) return "---";
        const y = String(d.getFullYear()).slice(2);
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `'${y}/${m}/${day}`;
      }

      // ä½•ãƒ¶æœˆå‰ã‹ã€‚ç„¡åŠ¹/æœªæ¥ã¯ -1
      function getDiffMonths(dateStr) {
        if (!dateStr) return -1;
        const d = new Date(dateStr);
        if (isNaN(d)) return -1;

        const now = new Date();
        let months = (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
        if (now.getDate() < d.getDate()) months -= 1;
        return months < 0 ? -1 : months;
      }

      /* --- UI Logic --- */
      function toggleDropdown(event, id) {
        event.stopPropagation();
        const target = document.getElementById(id);
        const trigger = event.currentTarget;
        const isActive = target.classList.contains("active");

        document.querySelectorAll(".filter-dropdown").forEach((d) => d.classList.remove("active"));

        if (!isActive) {
          const rect = trigger.getBoundingClientRect();
          target.style.top = rect.bottom + 5 + "px";
          target.style.left = Math.min(rect.left, window.innerWidth - 200) + "px";
          target.classList.add("active");
        }
      }

      function closeDropdown(id) {
        document.getElementById(id).classList.remove("active");
      }

      window.onclick = () => document.querySelectorAll(".filter-dropdown").forEach((d) => d.classList.remove("active"));

      function toggleFilters(groupId, checked) {
        document.querySelectorAll(`#${groupId} input`).forEach((cb) => (cb.checked = checked));
        updateView();
      }

      function getStatusBadgeClass(statusText) {
        const s = (statusText || "").toString().trim();
        const base = s.split(/[ï¼ˆ( ã€€:ï¼š]/)[0].trim();

        if (!base) return "st-stay";
        if (base.includes("å’æ¥­")) return "st-grad";
        if (base.includes("æ°¸çœ ")) return "st-death";
        if (base.includes("Trial")) return "st-trial";
        if (base.includes("æ²»ç™‚") || base.includes("å…¥é™¢")) return "st-medical";
        return "st-stay";
      }

      function updateView() {
        const selStatuses = Array.from(document.querySelectorAll("#statusFilters input:checked")).map((cb) => cb.value);
        const keyword = document.getElementById("searchKeyword").value.toLowerCase();
        const selGenders = Array.from(document.querySelectorAll("#genderFilters input:checked")).map((cb) => cb.value);
        const selFF = Array.from(document.querySelectorAll(`#ffFiltersHeader input:checked`)).map((cb) => cb.value);

        const limitVac =
          (parseInt(document.getElementById("alert_vac_y").value) || 0) * 12 +
          (parseInt(document.getElementById("alert_vac_m").value) || 0);

        const limitFlea = parseInt(document.getElementById("alert_flea_m").value) || 0;

        const filtered = cats.filter((c) => {
          // çŠ¶æ…‹åˆ¤å®šï¼ˆå…ˆé ­ã®çŠ¶æ…‹åã ã‘ï¼‰
          const rawStatus = (c.status || "").toString().trim();
          const baseStatus = rawStatus.split(/[ ã€€:ï¼š]/)[0];

          const matchStatus =
            (baseStatus && selStatuses.includes(baseStatus)) || (!baseStatus && selStatuses.includes("æœªè¨­å®š"));

          const matchKeyword = !keyword || `${c.name} ${c.origin} ${c.foster}`.toLowerCase().includes(keyword);
          const matchGender = selGenders.includes(c.gender || "ä¸æ˜");

          // FFã‚­ãƒ¼åŒ–ï¼ˆç°¡æ˜“ï¼‰
          let ffKey = "æœªæ¤œæŸ»";
          if (c.ff_result) {
            if (c.ff_result.includes("FIV+/FeLV+") || (c.ff_result.includes("FIV+") && c.ff_result.includes("FeLV+")))
              ffKey = "ä¸¡æ–¹+";
            else if (c.ff_result.includes("é™°æ€§")) ffKey = "é™°æ€§";
            else if (c.ff_result.includes("FIV+")) ffKey = "FIV+";
            else if (c.ff_result.includes("FeLV+")) ffKey = "FeLV+";
          }
          const matchFF = selFF.includes(ffKey);

          // â€»æœŸé™ã¯ã€Œè¡¨ç¤ºã€ã ã‘ã«ä½¿ã†ï¼ˆçµã‚Šè¾¼ã¿ã«æ··ãœãªã„ï¼‰
          return matchKeyword && matchStatus && matchGender && matchFF;
        });

        renderList(filtered, limitVac, limitFlea);
      }

      function getFFClass(text) {
        if (!text || text === "æœªæ¤œæŸ»") return "test-none";
        if (text.includes("FIV+/FeLV+")) return "test-positive-both";
        if (text.includes("FeLV+")) return "test-positive-felv";
        if (text.includes("FIV+")) return "test-positive-fiv";
        if (text.includes("é™°æ€§")) return "test-negative";
        return "";
      }

      function renderList(data, lVac, lFlea) {
        const list = document.getElementById("catList");
        list.innerHTML = "";

        data.forEach((c) => {
          const dVac = getDiffMonths(c.last_vaccine);
          const dFlea = getDiffMonths(c.last_flea);
          const vAlert = dVac >= lVac && lVac > 0;
          const fAlert = dFlea >= lFlea && lFlea > 0;
          const stClass = getStatusBadgeClass(c.status);
          const vacText = formatDateShort(c.last_vaccine) + (vAlert ? ' <span class="warn-icon">âš </span>' : "");
          const fleaText = formatDateShort(c.last_flea) + (fAlert ? ' <span class="warn-icon">âš </span>' : "");
          const row = document.createElement("tr");
          row.onclick = () => (window.location.href = `28+33 G5.html?id=${c.id}`);
          row.addEventListener("contextmenu", (e) => {
            e.preventDefault(); // ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‡ºã•ãªã„
            e.stopPropagation(); // window clickã§å³é–‰ã˜ãªã„ã‚ˆã†ã«
            openCtxMenu(e.clientX, e.clientY, c.id);
          });

          row.innerHTML = `
            <td class="thumb-cell">${c.photo ? `<img src="${c.photo}" class="cat-thumb">` : ""}</td>
            <td><span class="status-badge ${stClass}">${c.status || "åœ¨ç•™"}</span></td>
            <td><strong>${c.name || "åå‰ãªã—"}</strong></td>
            <td>${c.gender || "---"}</td>
            <td>${c.age_text || "---"}</td>
            <td class="${getFFClass(c.ff_result)}">${c.ff_result || "æœªæ¤œæŸ»"}</td>
          
            <td>${c.origin || "---"}</td>
            <td>${c.foster || "---"}</td>
            <td class="${vAlert ? "alert-text" : ""}">${vacText}</td>
            <td class="${fAlert ? "alert-text" : ""}">${fleaText}</td>
          `;

          list.appendChild(row);
        });

        document.getElementById("counter").innerText = `ç™»éŒ²æ•°: ${cats.length}åŒ¹ (è©²å½“: ${data.length}ä»¶)`;
      }

      function sortData(key) {
        if (sortConfig.key === key) sortConfig.direction *= -1;
        else {
          sortConfig.key = key;
          sortConfig.direction = 1;
        }
        cats.sort(
          (a, b) => (a[key] || "").toString().localeCompare((b[key] || "").toString(), "ja") * sortConfig.direction,
        );
        updateView();
      }

      window.onload = loadData;

      // â€» openDetail ã¯ã‚ãªãŸã®ç’°å¢ƒã«åˆã‚ã›ã¦åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‹æ—¢å­˜å®Ÿè£…ã‚’ä½¿ã£ã¦ãã ã•ã„
      function openDetail(mode) {
        if (mode === "new") {
          window.location.href = `28+33 G5.html?id=new`;
        }
      }

      let ctxTargetId = null;

      function openCtxMenu(x, y, catId) {
        const menu = document.getElementById("ctxMenu");
        ctxTargetId = catId;

        // ç”»é¢å¤–ã«ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«èª¿æ•´
        menu.hidden = false;
        const w = 200;
        const h = 92;
        const left = Math.min(x, window.innerWidth - w - 6);
        const top = Math.min(y, window.innerHeight - h - 6);

        menu.style.left = left + "px";
        menu.style.top = top + "px";
      }

      function closeCtxMenu() {
        const menu = document.getElementById("ctxMenu");
        menu.hidden = true;
        ctxTargetId = null;
      }

      // DBã‚ªãƒ¼ãƒ—ãƒ³ï¼ˆindex8ã® loadData ã¨åŒã˜DBã‚’ä½¿ã†ï¼‰
      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, 1);
          req.onsuccess = (e) => resolve(e.target.result);
          req.onerror = () => reject(req.error);
        });
      }

      async function deleteCatById(catId) {
        if (!catId || catId === "new") return;

        // ã“ã“ã¯æœ€å°ã§ confirm ã«ã—ã¦ã„ã¾ã™ï¼ˆå¿…è¦ãªã‚‰ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å·®ã—æ›¿ãˆå¯èƒ½ï¼‰
        const ok = window.confirm("ã“ã®ç™»éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
        if (!ok) return;

        const db = await openDB();
        await new Promise((resolve, reject) => {
          const tx = db.transaction([STORE_SUMMARY, STORE_DETAIL], "readwrite");
          tx.objectStore(STORE_SUMMARY).delete(catId);
          tx.objectStore(STORE_DETAIL).delete(catId);
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });

        // ç”»é¢å´ã®é…åˆ—ã‚‚æ›´æ–°ã—ã¦å†æç”»
        cats = cats.filter((c) => c.id !== catId);
        updateView();
      }

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆåˆå›ã ã‘ï¼‰
      (function initCtxMenu() {
        const delBtn = document.getElementById("ctxDeleteBtn");
        const cancelBtn = document.getElementById("ctxCancelBtn");

        delBtn.addEventListener("click", async () => {
          const id = ctxTargetId;
          closeCtxMenu();
          await deleteCatById(id);
        });

        cancelBtn.addEventListener("click", () => closeCtxMenu());

        // ç”»é¢ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.addEventListener("click", () => closeCtxMenu());
        // Escã§é–‰ã˜ã‚‹
        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeCtxMenu();
        });
      })();
    </script>
    <!-- å³ã‚¯ãƒªãƒƒã‚¯ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  </body>
</html>
